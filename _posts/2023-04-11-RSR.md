---
layout: post
title: "macOS's Rapid Security Response: Designed into a corner"
date: 2023-04-11 7:00:00 -0600
categories: macOS
---

With [macOS 13.3.1](https://mrmacintosh.com/macos-ventura-13-3-1-update-22e261-whats-new/) dropping last week, some people have been wondering what happened to Apple's featured ["Rapid Security Response"](https://support.apple.com/en-ca/guide/deployment/dep93ff7ea78/web) system they showed off back at WWDC2022? For some reason Apple keeps shipping their usual slow, bulky security updates opposed to the advertised small and "rapid" security updates.

Today we'll look into how the Rapid Security Response was implemented and how Apple designed themselves into a corner with this new system.

----------

* [Rapid Security Response: Cryptex comes to the Mac](#rapid-security-response-cryptex-comes-to-the-mac)
* [How Rapid Security Responses Updates work](#how-rapid-security-response-updates-work)
* [Where Rapid Security Response falls short](#where-rapid-security-response-falls-short)

## Rapid Security Response: Cryptex comes to the Mac

With macOS Ventura, Apple changed a fair number of internals including how they handle their userspace binaries (namely Safari and the dyld shared caches). [As I wrote last June](https://khronokernel.github.io/macos/2022/06/22/VENTURA-DYLD.html), Apple switched from keeping the dylds on the APFS Snapshotted Root Volume to the system's Preboot volume with 2 clear goals:

* Separate major userspace updates from root volume updates
* Implement more per-architecture differences

When they moved it to Preboot, they adopted the Cryptex system previously seen with [Apple's Security Research Devices running iOS 14](https://support.apple.com/en-ca/guide/security/seca7ff718d2/web). 

The Cryptex system can be seen as a pseudo-overlay to the operating system's root volume, mounted under `/System/Volumes/Preboot`. 

* Application calls to the root volume will instead be re-routed to the Cryptex paths (this is why apps that hard code library paths didn't break in Ventura)
* Cryptex binaries should always take precedent over root volume binaries
  * Similar logic to Apple's dyld system, on-disk binaries will always take precendent over ones fused in the dyld shared cache

| OS mount (primarily dyld cache) | App mount (primarily Safari) |
| :--- | :--- |
| ![Cryptex OS](/images/posts/2023-04-11-RSR/Cryptex-OS.png) | ![Cryptex App](/images/posts/2023-04-11-RSR/Cryptex-App.png) |

Regarding raw files, the Cryptex disk images can be found under `/System/Volumes/Preboot/<UUID>/cryptex1/current`:

<div>
             <img src="/images/posts/2023-04-11-RSR/Cryptex-Disk-Image.png" height="512" />
</div>

## How Rapid Security Response Updates work

Now let's take a peak at what's inside a Rapid Security Response Update. For this we'll look at macOS 13.2 Beta 1 (22D5027d)'s RSR update, [build 22D7750270d (a)](https://updates.cdn-apple.com/2022WinterSeed/patches/032-16395/CCC75E06-7CD5-4C48-97EB-8CB5AFCE0120/com_apple_MobileAsset_MacSplatSoftwareUpdate/3b1cf1c4e8718929620318f8eb810ee83e7abdae.zip).

When we download the update, we'll see the following file structure:

<div>
             <img src="/images/posts/2023-04-11-RSR/RSR-Sample.png" height="512" />
</div>

For us, we specifically care about the following:

* cryptex-app
* cryptex-app-rev
* cryptex-system-arm64e
* cryptex-system-arm64e-rev

These files are of the `RIDIFF10` file format, which is the same as what Apple uses to apply OS updates on systems in macOS Big Sur and newer. 
* However we see something new here, the `-rev` files. These are used to revert the RSR update, which is a handy feature especially when RSRs were in beta
* Also pay attention to file size, the RSR was only 120MB compared to a normal macOS update which is 3GB~. This is because RSRs are meant to only patch small portions of the OS, or even include stand alone binaries to override the dyld version.

----------

To apply (or revert) these updates, macOS loads `/usr/lib/libParallelCompression.dylib` and requests `RawImagePatch()` to apply the image patches onto an existing Cryptex.

* Credit to [DhinakG](https://github.com/dhinakg) and [ASentientBot](https://github.com/ASentientBot) for their research

```py
class RawImagePatchArgs(ctypes.Structure):
    _fields_ = [
        ("progressFunc", ctypes.c_void_p),    # Optional.
        ("progressFuncKey", ctypes.c_void_p), # Optional. Can be anything you want, even NULL. Passed to progressFunc.
        ("inputFile", ctypes.c_char_p),       # Optional. If not present, `*full replacement*`.
        ("outputFile", ctypes.c_char_p),
        ("patchFile", ctypes.c_char_p),
        ("isNotCryptexCache", ctypes.c_bool),
        ("threadCount", ctypes.c_uint32),     # Limited to 2 threads max.
        ("verboseLevel", ctypes.c_uint32),
    ]
```

## Where Rapid Security Response falls short

So why did both macOS 13.2.1 and 13.3.1 ship instead of using the new "fancy" Rapid Security Response? Well the answer is in what RSRs fail to handle: Kernel Space Updates

Something you may have noticed in our above conversation is a lack of security handling for updating macOS's kernel and kernel extensions (kexts). The reason for this is that parts of Apple's Kernel Cache system still resides on the APFS Snapshotted Root Volume.

A quick break down of Apple's current Kernel Caching system (known as Kernel Collection):

* BootKernelExtensions.kc
  * Houses macOS's kernel (XNU) as well as essential kexts required to boot
  * Resides on the Preboot volume
* SystemKernelExtensions.kc
  * Houses any additional kexts including graphics and audio
  * Resides on APFS Snapshotted Root Volume
  * Unused on Apple Silicon installs
* AuxiliaryKernelExtensions.kc
  * Houses 3rd party kexts, primarily installed by end-users
  * Resides on the Data volume

| Boot KC | System KC | Aux KC |
| :--- | :--- | :--- |
| ![KC Boot](/images/posts/2023-04-11-RSR/KC-Boot.png) | ![KC System](/images/posts/2023-04-11-RSR/KC-System.png) | ![KC Auxiliary](/images/posts/2023-04-11-RSR/KC-Auxiliary.png) |

----------

Because of how Apple architected the Kernel Collection system, all 3 caches are linked together and as such cannot be easily separated. Additionally Apple killed the ability to hot-load kernel extensions from disk, forcing a rebuild of the Kernel Collection each time some wants to either update the kernel or a kext.

* Now compared this to the dyld system, Apple can simply override the dyld binary with a stand alone one allowing for both quick and small updates

----------

Now let's see what's inside the [security contents for macOS 13.3.1](https://support.apple.com/en-us/HT213721):

> IOSurfaceAccelerator
> Impact: An app may be able to execute arbitrary code with kernel privileges. Apple is aware of a report that this issue may have been actively exploited.

And as we'd expect, the exploit is inside a kext! And thus, RSRs cannot be used to patch the exploit...

* Same issue applies in 13.2.1 as macOS's kernel was updated: [About the security content of macOS Ventura 13.2.1](https://support.apple.com/en-us/HT213633)
