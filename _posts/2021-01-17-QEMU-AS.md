---
layout: post
title:  "Virtualizing OpenCore and x86 macOS on Apple Silicon"
date:   2021-01-17 7:00:00 -0600
categories: Apple Silicon
---

Recently I purchased an M1 equipped 13" MacBook Pro. Overall the machine has been absolutely amazing however I have 1 big issue transitioning from my old Intel Hackintosh:

* Missing macOS guest VMs

While its clear that both [Parallels](https://www.parallels.com/) and [VMWare](https://www.vmware.com) will support Apple Silicon with macOS guests in the future, the question is when. Additionally, it's also unclear if we'll ever get x86 emulation from them or if its strictly ARM64 only. A bit of a shame especially as I do frequently boot old macOS VMs versions to check for bugs.

To get around this, I wanted to see if our good ol friend QEMU can help us out and do full x86 emulation.

For today's experiment, we'll try and see if we can get to the macOS recovery environment with a vanilla macOS BaseSystem. Of course we'll be getting a bit of help from OpenCore to move this along.

## Getting started

Before we beging, we'll need a few things:

* [UTM](https://github.com/utmapp/UTM/releases)
  * A very nice wrapper for QEMU in macOS, additionally also supports iOS
* [OpenCore Image](https://github.com/khronokernel/khronokernel.github.io/blob/master/Binaries/OpenCore/README.md)
  * Our bootloader to help launch macOS, there's a few options to choose from:
	* [EFI-MODERN](https://github.com/khronokernel/khronokernel.github.io/blob/master/Binaries/OpenCore/EFI-MODERN.img.zip?raw=true): macOS 10.15 and newer supported
	* [EFI-LEGACY](https://github.com/khronokernel/khronokernel.github.io/blob/master/Binaries/OpenCore/EFI-LEGACY.img.zip?raw=true): Mac OS X 10.6 through 10.14 supported
	* [EFI-i386](https://github.com/khronokernel/khronokernel.github.io/blob/master/Binaries/OpenCore/EFI-i386.img.zip?raw=true): Mac OS X 10.4 through 10.7 supported
  * [Source](https://github.com/acidanthera/OpenCorePkg/releases)
* [OVMF Binary](https://www.kraxel.org/repos/jenkins/edk2/)
  * Our UEFI image for QEMU
    * Note we want `edk2.git-ovmf-x64` specifically
  * [Source](https://github.com/tianocore/edk2/tree/master/OvmfPkg)
* macOS Image
  * See [macrecovery](https://github.com/acidanthera/OpenCorePkg/tree/master/Utilities/macrecovery) in OpenCorePkg on how to download from Apple's servers
    * This should provide you with a BaseSystem/RestoreImage.dmg for use to play with

To start, open up the UTM.dmg and add UTM.app to the `Applications/` folder.

Next, download OVMF from the [Qemu firmware repo](https://www.kraxel.org/repos/jenkins/edk2/) and run the following:

```sh
cd ~/Downloads
# Extract the .rpm
# Ensure filename is correct to yours
tar -xf edk2.git-ovmf-x64-0-20201222.1538.g014b9850f2.noarch.rpm
# Next rename and move the file into UTM
cp usr/share/edk2.git/ovmf-x64/OVMF_CODE-pure-efi.fd /Applications/UTM.app/Contents/Resources/qemu/OVMF.bin
```

From here, we can open UTM.app and get started:

![](/images/posts/2021-01-17-QEMU-AS/UTM-Start.png)

We'll first want to make a fresh VM, here I'll list a few of the required settings to boot:

| System | QEMU | Drives | Network |
| :--- | :--- | :--- | :--- |
| ![](/images/posts/2021-01-17-QEMU-AS/UTM-Settings-System.png) | ![](/images/posts/2021-01-17-QEMU-AS/UTM-Settings-QEMU.png) | ![](/images/posts/2021-01-17-QEMU-AS/UTM-Settings-Drives.png) | ![](/images/posts/2021-01-17-QEMU-AS/UTM-Settings-Network.png) |

* **System**:
  * Architecture: `x86_64`
  * System: `Standard PC (Q35 + ICH9, 2009)`
  * Memory: `4096MB`
  * Force Multicore: `True`
    * Note forcing multicore greatly increases the VM speed, however bugs may appear with this.
* **QEMU**:
  * `-bios`
  * `/Applications/UTM.app/Contents/Resources/qemu/OVMF.bin`
  * `-cpu`
  * `Penryn,+ssse3,+sse4.1,+sse4.2`
* **Drives**:
  * EFI.img:
    * Image Type: `Disk Image`
	* Interface: `VirtIO`
  * BaseSystem.dmg:
    * Image Type: `Disk Image`
	* Interface: `USB`
  * **Extra Disk**(If you plan to install macOS):
    * Image Type: `Disk Image`
	* Interface: `USB`
	* Size: `20480`
* **Network**:
  * Enabled: `True`
  * Emulated Network Card: `VMWare Paravirlulized Ethernet V3`

Once these are all done, we can now boot our VM!

## Booting the VM

| 1. OVMF Start | 2. OpenCore Picker | 3. macOS Kernel Starts |
| :--- | :--- | :--- |
| ![](/images/posts/2021-01-17-QEMU-AS/OVMF-Start.png) | ![](/images/posts/2021-01-17-QEMU-AS/OpenCore-Picker.png) | ![](/images/posts/2021-01-17-QEMU-AS/Mojave-Kernel.png) |

The boot process is slow however, and I mean *very* slow. But after ***17min***(Reduced to 8min with Force Multicore) we finally reach macOS's recovery screen!

![](/images/posts/2021-01-17-QEMU-AS/Mojave-Language.png)

* Note: If your mouse doesn't work, try pressing Control+Option+Arrows
* Note 2: To resolve Recovery Server contact errors, open terminal and run the following:

```
# Launch scutil
scutil
> open
> d.init
# Setting to Google's DNS
> d.add ServerAddresses * 8.8.8.8 9.9.9.9
> set State:/Network/Service/PRIMARY_SERVICE_ID/DNS
# Verify it worked
> d.show
> quit
```

The OS is unusable to say the least, and unfortunately won't get much better even with tinkering. However the fact QEMU is able to emulate an Intel Penryn PC so well is quite remarkable, and OpenCore has made this much easier to build and boot.


